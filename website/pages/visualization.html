<body id="app">
    <header>
        <shared-header></shared-header>
    </header>
    <main>
        <visualization-preview :visualization="visualization"></visualization-preview>
        <div ref="display_container" class="container my-5" style="height: 200px;">

        </div>
        <div class="container mb-4">
            <h1 class="mb-2">{{ visualization.name }}</h1>
            <div class="d-flex">
                <tag v-for="tag in visualization.tags" :name="tag.name" :type="tag.type" class="me-1" @on_tag_click="on_visualization_tag_click(tag)"></tag>
            </div>
        </div>
        <div class="container mb-4" v-html="visualization.description"></div>
        <div class="w-100 py-4 bg-body-tertiary">
            <div class="container">
                <visualization-wizard :visualization="visualization" class="mb-4"></visualization-wizard>
                <visualization-content :visualization="visualization"></visualization-content>
            </div>
        </div>
    </main>
    <footer>
        <shared-footer class="container py-5"></shared-footer>
    </footer>
</body>
<script src="https://unpkg.com/vtk.js@29.3.0/vtk.js"></script>
<script type="module">
    import { createApp, ref } from "vue"
    import VisualizationPreview from "components/visualization_preview.js"
    import VisualizationContent from "components/visualization_content.js"
    import VisualizationWizard from "components/visualization_wizard.js"
    import SharedHeader from "components/shared_header.js"
    import SharedFooter from "components/shared_footer.js"
    import Tag from "components/tag.js"

    let app = createApp(
    {
        setup()
        {
            let visualization = ref(
            {
                name: "",
                date: "",
                tags: [],
                images: [],
                resources: [],
                templates: [],
                description: ""
            });

            let display_container = ref(null);

            function on_visualization_tag_click(tag)
            {
                console.log(tag);
            }

            return {
                visualization,
                display_container,
                on_visualization_tag_click
            }
        },
        async mounted()
        {
            const parameters = new URLSearchParams(window.location.search);

            const visualization_name = parameters.get("name");
            const visualization_request = 
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(
                {
                    visualization_name
                })
            }

            const response = await fetch("/api/fetch_visualization", visualization_request);

            if(response.ok)
            {
                this.visualization = await response.json();    
            }

            return;

            const fullScreenRenderer = vtk.Rendering.Misc.vtkFullScreenRenderWindow.newInstance(
            {
                container:  this.display_container
            });
            const renderer = fullScreenRenderer.getRenderer();
            const renderWindow = fullScreenRenderer.getRenderWindow();

            const sceneImporter = vtk.IO.Core.vtkHttpSceneLoader.newInstance(
            {
                renderer,
                fetchGzip: false,
            });
            sceneImporter.setUrl("/database/volume");
            sceneImporter.onReady(() =>
            {
                renderWindow.render();
            });
        }
    });

    app.component("visualization-preview", VisualizationPreview);
    app.component("visualization-content", VisualizationContent);
    app.component("visualization-wizard", VisualizationWizard);
    app.component("shared-header", SharedHeader);
    app.component("shared-footer", SharedFooter);
    app.component("tag", Tag);
    app.mount("#app");
</script>