<body id="app">
    <header>
        <browser-header v-model:browser_query="browser_query" v-model:browser_sorting="browser_sorting"></browser-header>
    </header>
    <main>
        <browser-filter class="border-bottom d-md-none" v-model:browser_filters="browser_filters"></browser-filter>
        <div class="d-flex bg-body-tertiary">
            <browser-filter class="card m-3 d-none d-md-block " style="width: 300px;" v-model:browser_filters="browser_filters"></browser-filter>
            <div class="flex-fill d-flex flex-wrap">
                <browser-item v-for="item of browser_items" :browser_item="item"></browser-item>
            </div>
        </div>
    </main>
    <footer>
        <shared-footer class="container py-5"></shared-footer>
    </footer>
</body>
<script type="module">
    import { createApp, ref, watch } from "vue"
    import BrowserHeader from "components/browser_header.js"
    import BrowserFilter from "components/browser_filter.js"
    import BrowserItem from "components/browser_item.js"
    import SharedFooter from "components/shared_footer.js"

    let app = createApp(
    {
        setup()
        {
            let browser_items = ref([]);
            let browser_query = ref("");

            let browser_sorting = ref(
            {
                type: "relevance",
                direction: "descending"
            });
            
            let browser_filters = ref(
            {
               date_begin: "01 Jan 2023",
               date_end: "01 Dec 2023",
               tags: [] 
            });

            watch([browser_query, browser_sorting, browser_filters], async (old_state, new_state) =>
            {
                const technique_request =
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(
                    {
                        query: browser_query.value,
                        sorting: browser_sorting.value.type + "_" + browser_sorting.value.direction,
                        filter_date_begin: browser_filters.value.date_begin, 
                        filter_date_end: browser_filters.value.date_end,
                        filter_tags: browser_filters.value.tags
                    })
                };

                console.log("Test");
                
                let technique_response = await (await fetch("/api/search_techniques", technique_request)).json();
                browser_items.value = [];

                for(const technique of technique_response)
                {
                    const browser_item = 
                    {
                        name: technique.name,
                        tags: technique.tags,
                        images: technique.images
                    };

                    browser_items.value.push(browser_item);
                }
            }, { immediate: true, deep: true});

            return {
                browser_items,
                browser_query,
                browser_sorting,
                browser_filters
            }
        }
    });

    app.component("browser-header", BrowserHeader);
    app.component("browser-filter", BrowserFilter);
    app.component("browser-item", BrowserItem);
    app.component("shared-footer", SharedFooter);
    app.mount("#app");
</script>